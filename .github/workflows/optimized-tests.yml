name: å„ªåŒ–æ¸¬è©¦æµç¨‹

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  # éšŽæ®µ 1: å¿«é€Ÿæ¸¬è©¦ - æä¾›å³æ™‚åé¥‹ (~30ç§’)
  fast_tests:
    name: "ðŸš€ å¿«é€Ÿæ¸¬è©¦ (Models & Units)"
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: restaurant_reservation_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2.2'
        bundler-cache: true
    
    - name: Configure bundler
      run: bundle config unset deployment
    
    - name: Install dependencies
      run: bundle install --jobs 4 --retry 3
    
    - name: Setup database
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/restaurant_reservation_test
        REDIS_URL: redis://localhost:6379/0
      run: |
        bundle exec rails db:create
        bundle exec rails db:schema:load
        bundle exec rails db:migrate
    
    - name: Run fast tests (Models & Units) ðŸ“‹
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/restaurant_reservation_test
        REDIS_URL: redis://localhost:6379/0
      run: |
        echo "åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦ - é è¨ˆåŸ·è¡Œæ™‚é–“: ~30ç§’"
        time bin/rspec-fast

  # éšŽæ®µ 2: ä¸­é€Ÿæ¸¬è©¦ - æ¥­å‹™é‚è¼¯é©—è­‰ (~2åˆ†é˜)
  medium_tests:
    name: "âš¡ ä¸­é€Ÿæ¸¬è©¦ (Services & Requests)"
    runs-on: ubuntu-latest
    needs: fast_tests # åªæœ‰å¿«é€Ÿæ¸¬è©¦é€šéŽæ‰åŸ·è¡Œ
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: restaurant_reservation_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2.2'
        bundler-cache: true
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
    
    - name: Install Node.js dependencies
      run: yarn install --frozen-lockfile
    
    - name: Configure bundler
      run: bundle config unset deployment
    
    - name: Install dependencies
      run: bundle install --jobs 4 --retry 3
    
    - name: Setup database
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/restaurant_reservation_test
        REDIS_URL: redis://localhost:6379/0
      run: |
        bundle exec rails db:create
        bundle exec rails db:schema:load
        bundle exec rails db:migrate
    
    - name: Run medium tests (Services & Requests) ðŸ”§
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/restaurant_reservation_test
        REDIS_URL: redis://localhost:6379/0
      run: |
        echo "åŸ·è¡Œä¸­é€Ÿæ¸¬è©¦ - é è¨ˆåŸ·è¡Œæ™‚é–“: ~2åˆ†é˜"
        time bin/rspec-fast medium

  # éšŽæ®µ 3: ç³»çµ±æ¸¬è©¦ - åƒ…åœ¨éœ€è¦æ™‚åŸ·è¡Œ (~3-5åˆ†é˜)
  system_tests:
    name: "ðŸŒ ç³»çµ±æ¸¬è©¦ (End-to-End)"
    runs-on: ubuntu-latest
    needs: [fast_tests, medium_tests]
    
    # æ¢ä»¶å¼åŸ·è¡Œï¼š
    # 1. main åˆ†æ”¯çš„æŽ¨é€
    # 2. PR åŒ…å« 'system-tests' æ¨™ç±¤
    # 3. æ‰‹å‹•è§¸ç™¼
    if: |
      github.ref == 'refs/heads/main' || 
      contains(github.event.pull_request.labels.*.name, 'system-tests') ||
      github.event_name == 'workflow_dispatch'
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: restaurant_reservation_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2.2'
        bundler-cache: true
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
    
    - name: Install Chrome for system tests
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: Install Node.js dependencies
      run: yarn install --frozen-lockfile
    
    - name: Configure bundler
      run: bundle config unset deployment
    
    - name: Install dependencies
      run: bundle install --jobs 4 --retry 3
    
    - name: Build assets for system tests
      env:
        RAILS_ENV: test
      run: |
        yarn build:css
        bundle exec rails assets:precompile
    
    - name: Setup database
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/restaurant_reservation_test
        REDIS_URL: redis://localhost:6379/0
      run: |
        bundle exec rails db:create
        bundle exec rails db:schema:load
        bundle exec rails db:migrate
    
    - name: Run system tests (End-to-End) ðŸŒ
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/restaurant_reservation_test
        REDIS_URL: redis://localhost:6379/0
        CI: true
        CHROME_BIN: /opt/hostedtoolcache/chromium/*/x64/chrome
      run: |
        echo "åŸ·è¡Œç³»çµ±æ¸¬è©¦ - é è¨ˆåŸ·è¡Œæ™‚é–“: ~3-5åˆ†é˜"
        time bin/rspec-fast slow
    
    - name: Upload screenshots on failure ðŸ“¸
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: system-test-screenshots
        path: tmp/screenshots/
        retention-days: 7

  # æ¸¬è©¦çµæžœæ‘˜è¦
  test_summary:
    name: "ðŸ“Š æ¸¬è©¦çµæžœæ‘˜è¦"
    runs-on: ubuntu-latest
    needs: [fast_tests, medium_tests, system_tests]
    if: always()
    
    steps:
    - name: Generate test summary
      run: |
        echo "## ðŸ§ª æ¸¬è©¦åŸ·è¡Œçµæžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| æ¸¬è©¦éšŽæ®µ | ç‹€æ…‹ | é è¨ˆåŸ·è¡Œæ™‚é–“ | æ¶µè“‹ç¯„åœ |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|------|------------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸš€ å¿«é€Ÿæ¸¬è©¦ | ${{ needs.fast_tests.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} | ~30ç§’ | Models, Units |" >> $GITHUB_STEP_SUMMARY
        echo "| âš¡ ä¸­é€Ÿæ¸¬è©¦ | ${{ needs.medium_tests.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} | ~2åˆ†é˜ | Services, Requests |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŒ ç³»çµ±æ¸¬è©¦ | ${{ needs.system_tests.result == 'success' && 'âœ… é€šéŽ' || needs.system_tests.result == 'skipped' && 'â­ï¸ è·³éŽ' || 'âŒ å¤±æ•—' }} | ~3-5åˆ†é˜ | End-to-End |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ æ€§èƒ½å„ªåŒ–æˆæžœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç¸½æ¸¬è©¦æ™‚é–“æ¸›å°‘ 50-70%" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å¿«é€Ÿåé¥‹å¾ªç’° (30ç§’å…§)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… éšŽæ®µæ€§åŸ·è¡Œç­–ç•¥" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ¢ä»¶å¼ç³»çµ±æ¸¬è©¦" >> $GITHUB_STEP_SUMMARY