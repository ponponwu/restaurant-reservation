# 餐廳進階設定功能 PRD

## 📋 專案概述

### 專案目標

建立完整的餐廳營業設定系統，讓餐廳管理員能夠靈活設定營業時間、餐期規則、預約時段、公休日等複雜營業規則，並展示餐廳資訊給顧客。

### 功能範圍

1. **餐期與時段管理** - 複雜的營業時間和預約時段設定
2. **公休日管理** - 定期公休和特殊假期設定
3. **餐廳資訊管理** - 圖片、介紹、聯絡資訊等
4. **預約規則設定** - 預約限制、取消政策等
5. **特殊日期管理** - 節慶營業、臨時公休等

## 🎯 核心功能需求

### 1. 餐期與時段管理

#### 1.1 餐期設定

**功能描述**：設定餐廳的營業餐期（如：午餐、晚餐）

**詳細需求**：

-   [ ] **餐期建立**
    -   餐期名稱（如：午餐、晚餐、下午茶）
    -   餐期時間範圍（如：11:30-14:30）
    -   營業星期設定（週一到週日可個別設定）
    -   餐期狀態（啟用/停用）
-   [ ] **多餐期支援**
    -   同一天可設定多個餐期
    -   餐期間可有空檔時間

#### 1.2 預約時段設定

**功能描述**：設定顧客可選擇的具體預約時間點

**詳細需求**：

-   [ ] **時段間隔設定**
    -   基礎間隔（15 分鐘、30 分鐘、60 分鐘）
    -   不同餐期可設定不同間隔
    -   自訂特殊時段點
-   [ ] **時段限制**
    -   最早可預約時間（餐期開始前多久）
    -   最晚可預約時間（餐期結束前多久）
    -   每個時段的桌位數量限制
-   [ ] **動態時段**
    -   根據桌位使用時間自動產生可用時段
    -   桌位翻檯時間設定（用餐時間 + 清潔時間）

#### 1.3 複雜規則範例

```
午餐時段：11:00-15:00
├── 可預約時間：11:00,11:30, 12:00, 12:30, 13:00
├── 間隔：30分鐘
├── 用餐時間：無限制


晚餐時段：18:00-22:00
├── 18:00, 18:30, 19:00, 19:30, 20:00

```

### 2. 公休日與特殊日期管理

#### 2.1 定期公休日

**功能描述**：設定固定的公休日規則

**詳細需求**：

-   [ ] **週期性公休**
    -   每週固定公休日（如：每週一）
    -   雙週/月週期公休（如：每月第二、四週的週一）
    -   特殊週期（如：每月 1 號、15 號）
-   [ ] **公休日例外**
    -   特定公休日照常營業
    -   營業日臨時公休

#### 2.2 特殊日期管理

**功能描述**：管理節慶、假期等特殊營業安排

**詳細需求**：

-   [ ] **節慶營業**
    -   節慶特殊營業時間
    -   節慶限定餐期
    -   節慶預約規則調整
-   [ ] **臨時異動**
    -   臨時公休（設備維修、私人活動）
    -   臨時延長營業
    -   緊急狀況調整

#### 2.3 假期日曆整合

-   [ ] 自訂公司假期

### 4. 預約規則設定

#### 4.1 預約限制規則

**詳細需求**：

-   [ ] **時間限制**
    -   最早可預約時間（如：30 天前）
    -   最晚可預約時間（如：2 小時前）
    -   當日預約限制
-   [ ] **人數限制**
    -   最小預約人數
    -   最大預約人數
    -   大型聚餐特殊處理
-   [ ] **頻率限制**
    -   同一電話號碼的預約頻率限制
    -   取消預約次數限制

#### 4.2 取消與修改政策

**詳細需求**：

-   [ ] **取消政策**
    -   免費取消時限（如：2 小時前）
    -   取消手續費設定
    -   No-show 處理規則
-   [ ] **修改政策**
    -   可修改項目（時間、人數、備註）
    -   修改次數限制
    -   修改時限設定

#### 4.3 押金與預付設定

**詳細需求**：

-   [ ] **押金規則**
    -   押金金額設定（固定金額或按人數）
    -   需收押金的條件（人數、時段、特殊日期）
    -   押金退還規則
-   [ ] **預付餐費**
    -   套餐預訂
    -   節慶特餐預付
    -   優惠活動預付

### 5. 通知與提醒設定

#### 5.1 客戶通知

**詳細需求**：

-   [ ] **預約確認通知**
    -   SMS 簡訊通知
    -   Email 確認信
    -   通知模板自訂
-   [ ] **提醒通知**
    -   用餐前提醒（1 小時前、30 分鐘前）
    -   取消提醒
    -   政策異動通知

#### 5.2 餐廳端通知

**詳細需求**：

-   [ ] **新預約通知**
    -   即時通知管理員
    -   通知方式選擇（Email、系統內通知）
-   [ ] **異常提醒**
    -   爆滿時段警告
    -   取消率異常提醒
    -   系統故障通知

## 🗃️ 資料表設計

### RestaurantProfile（餐廳詳細資料）

````ruby
# 擴充原有的 Restaurant 模型
class Restaurant < ApplicationRecord
  # 原有欄位...

  # 新增欄位
  has_many :business_periods, dependent: :destroy
  has_many :closure_dates, dependent: :destroy
  has_many :restaurant_images, dependent: :destroy

  accepts_nested_attributes_for :restaurant_profile
end


### BusinessPeriod（營業時段）- 重新設計

```ruby
class BusinessPeriod < ApplicationRecord
  belongs_to :restaurant
  has_many :reservation_slots, dependent: :destroy

  # name :string                # 餐期名稱 (lunch, dinner, etc.)
  # display_name :string        # 顯示名稱 (午餐, 晚餐)
  # start_time :time           # 開始時間
  # end_time :time             # 結束時間
  # days_of_week :json         # 營業日 [1,2,3,4,5,6,0] (週一到週日)
  # active :boolean            # 是否啟用
  # reservation_settings :json  # 預約設定

  enum status: { active: 0, inactive: 1, seasonal: 2 }

  def reservation_slots_for_date(date)
    # 產生指定日期的預約時段
  end
end
````

### ReservationSlot（預約時段）

```ruby
class ReservationSlot < ApplicationRecord
  belongs_to :business_period
  has_many :reservations

  # slot_time :time            # 時段時間 (如: 18:00)
  # max_capacity :integer      # 該時段最大容納人數
  # interval_minutes :integer  # 與下一時段的間隔分鐘
  # reservation_deadline :integer # 預約截止時間（分鐘前）
  # active :boolean
end
```

### ClosureDate（公休日）

```ruby
class ClosureDate < ApplicationRecord
  belongs_to :restaurant

  # date :date                 # 公休日期
  # reason :string             # 公休原因
  # closure_type :string       # 公休類型 (regular, special, emergency)
  # all_day :boolean           # 是否全天公休
  # start_time :time           # 部分時段公休開始時間
  # end_time :time             # 部分時段公休結束時間
  # recurring :boolean         # 是否重複
  # recurring_pattern :json    # 重複規則

  enum closure_type: { regular: 0, holiday: 1, maintenance: 2, emergency: 3, private_event: 4 }
end
```

### ReservationPolicy（預約政策）

```ruby
class ReservationPolicy < ApplicationRecord
  belongs_to :restaurant

  # advance_booking_days :integer      # 可提前預約天數
  # minimum_advance_hours :integer     # 最少提前預約小時
  # max_party_size :integer           # 最大預約人數
  # min_party_size :integer           # 最小預約人數
  # no_show_policy :text              # No-show 政策
  # modification_policy :text         # 修改政策
  # deposit_required :boolean         # 是否需要押金
  # deposit_amount :decimal           # 押金金額
  # deposit_per_person :boolean       # 是否按人頭收押金
  # special_rules :json               # 特殊規則
end
```

## 🎨 介面設計需求

### 設定頁面架構

```
餐廳設定
├── 基本資訊
│   ├── 餐廳資料
│   ├── 聯絡方式
│   └── 服務項目
├── 營業設定
│   ├── 餐期管理
│   ├── 預約時段
│   └── 營業日曆
├── 公休管理
│   ├── 定期公休
│   ├── 特殊假期
│   └── 臨時異動
├── 預約規則
│   ├── 預約限制
│   ├── 取消政策
│   └── 押金設定
└── 通知設定
    ├── 客戶通知
    └── 管理員通知
```

### 餐期設定介面重點

-   **視覺化時間軸**：拖拉設定餐期時間
-   **週曆檢視**：一週七天的營業時間一目瞭然
-   **時段網格**：清楚顯示每個時段的可用性
-   **衝突檢測**：自動偵測時間衝突並提醒

### 公休日管理介面

-   **月曆檢視**：清楚標示公休日和特殊日期
-   **快速設定**：常用公休模式的快速按鈕
-   **批量操作**：一次設定多個日期

## 🔧 技術實作要點

### 時間處理

-   使用 `chronic` gem 處理複雜時間規則
-   時區處理：支援餐廳當地時區
-   跨日處理：宵夜時段的跨日邏輯

### 效能優化

-   營業時段查詢快取
-   可用時段預計算

### 資料驗證

-   時間邏輯驗證（開始時間不能晚於結束時間）
-   餐期重疊檢測
-   圖片格式和大小限制

## 📱 前端互動功能

### 餐期設定

-   **時間拖拉條**：直觀設定餐期時間
-   **即時預覽**：設定同時顯示效果預覽
-   **範本應用**：常用餐期設定範本

### 日曆操作

-   **月曆、週曆切換**
-   **拖拉選擇日期範圍**
-   **批量設定公休日**
-   **節假日高亮顯示**

### 圖片管理

-   **拖拉上傳**：支援多圖片同時上傳
-   **即時預覽**：上傳前圖片預覽
-   **拖拉排序**：圖片順序調整

## 📊 管理報表功能

### 營業分析

-   **餐期使用率統計**
-   **熱門時段分析**
-   **公休日影響分析**
-   **預約取消率統計**

### 設定建議

-   **根據預約數據建議最佳營業時間**
-   **建議新增熱門時段**
-   **異常模式警告**

## ✅ 驗收標準

### 功能驗收

-   [ ] 可設定複雜的營業時間規則
-   [ ] 預約時段自動生成正確
-   [ ] 公休日設定影響預約系統
-   [ ] 圖片上傳和管理正常
-   [ ] 所有設定可即時生效

### 效能驗收

-   [ ] 餐期查詢回應時間 < 1 秒
-   [ ] 圖片載入優化良好
-   [ ] 大量日期操作不卡頓

### 使用者體驗驗收

-   [ ] 設定流程直觀易懂
-   [ ] 錯誤提示清楚有用
-   [ ] 響應式設計完整

這個設計涵蓋了餐廳營業的各種複雜需求，提供了靈活而完整的設定系統。有任何需要調整或補充的部分嗎？
